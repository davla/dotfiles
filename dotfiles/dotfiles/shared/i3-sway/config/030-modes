{%@@ from 'shared/i3-sway/macros.j2' import tui -@@%}

# This i3/sway configuration file contains mode definitions
#
# {{@@ header() @@}}

{#@@
    This macro allows a command to be executed with an explicit media player
    that has been interactively selected by the user via fzf.
    The command must:
    - Be executable via `xargs`
    - Accept a positional parameter `--player` as its last argument
-@@#}
{%@@ macro select_player(cmd) -@@%}

{{@@ tui("playerctl --list-all | fzf --no-preview \
    | xargs -I '{}' %s --player='{}'" % cmd) @@}}

{%@@- endmacro -@@%}

#######################################
# Media
#######################################

# This mode defines shortcuts for media controls, e.g. volume, screen
# brightness, etc

# Media commands
set $playback_prev active-playerctl previous
set $playback_next active-playerctl next
set $playback_toggle active-playerctl play-pause
set $volume_down volume -ne 1000 down 5
set $volume_up volume -ne 1000 -x 100 up 5
set $volume_mute volume -ne 1000 mute

# Playback
bindsym XF86AudioPrev exec --no-startup-id $playback_prev
bindsym XF86AudioNext exec --no-startup-id $playback_next
bindsym XF86AudioPlay exec --no-startup-id $playback_toggle
bindsym Shift+XF86AudioPrev exec {{@@ select_player('$playback_prev') @@}}
bindsym Shift+XF86AudioNext exec {{@@ select_player('$playback_next') @@}}
bindsym Shift+XF86AudioPlay exec {{@@ select_player('$playback_toggle') @@}}

# Volume control
bindsym XF86AudioMute exec --no-startup-id $volume_mute
bindsym XF86AudioLowerVolume exec --no-startup-id $volume_down
bindsym XF86AudioRaiseVolume exec --no-startup-id $volume_up

bindsym $mod+$mode_shifter_key+m mode "media"
mode "media" {
    # Browser
    bindsym --release d exec xdotool key XF86Back
    bindsym --release f exec xdotool key XF86Forward

    # Playback
    bindsym h exec --no-startup-id $playback_prev
    bindsym k exec --no-startup-id $playback_next
    bindsym j exec --no-startup-id $playback_toggle
    bindsym Shift+h exec {{@@ select_player('$playback_prev') @@}}
    bindsym Shift+k exec {{@@ select_player('$playback_next') @@}}
    bindsym Shift+j exec {{@@ select_player('$playback_toggle') @@}}

    # Volume
    bindsym y exec --no-startup-id $volume_down
    bindsym u exec --no-startup-id $volume_mute
    bindsym i exec --no-startup-id $volume_up

    # Back to normal: Enter or Escape or mode-enabling shortcut
    bindsym Return mode "default"
    bindsym Escape mode "default"
    bindsym $mod+$mode_shifter_key+m mode "default"
}
