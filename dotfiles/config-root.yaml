%YAML 1.2
---
# This dotdrop config file is meant for root dotfiles.

actions:
  pre:
    _create_if_empty: "[ -s '{0}' ] || printf '{1}' > '{0}'"

    # This action installs the packages providing the files modified by the
    # environment profile
    environment: |-
      case "$DISTRO" in
          'arch')
              pacman -S --needed bash dash zsh
              ;;

          'debian')
              apt-get install bash dash zsh
              ;;
      esac

  post:
    # This action applies the grub configuration
    grub: update-grub

    ddclient: sh ./actions/ddclient.sh '{0}'

    # This action enables systemd-resolved and integrates it with resolv.conf
    enable-systemd-resolved: |
      systemctl enable --now systemd-resolved
      ln -sf ../run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

    locales: sh ./actions/locales.sh

    # This action compiles the keyindicator2 custom i3block
    i3blocks_keyindicator2: |
      apt-get install build-essential libx11-dev
      make --directory '{{@@ _dotfile_abs_dst @@}}' \
          PREFIX='{{@@ i3blocklets_install_path @@}}' \
          ACTIVE_KEY_COLOR='{{@@ light_theme_color @@}}' \
          INACTIVE_KEY_COLOR='{{@@ i3bar_inactive_color @@}}' \
          CAPS_LABEL='󰌎' \
          LABEL_SEPARATOR='<span size=\"1.8pt\"> </span>' \
          PANGO_PROPS='size=\"180%\" font_weight=\"bold\"' \
          clean install

    # This action compiles the network-status custom i3block
    i3blocks_network-status: |
      case "$DISTRO" in
          'arch')
              pacman -S --needed dash base-devel
              ;;

          'debian')
              apt-get install build-essential
              ;;
      esac
      make --directory '{{@@ _dotfile_abs_dst @@}}' \
          PREFIX='{{@@ i3blocklets_install_path @@}}' \
          GOOD_CONNECTION_QUALITY_COLOR='{{@@ dark_theme_color @@}}' \
          MEDIUM_CONNECTION_QUALITY_COLOR='{{@@ main_theme_color @@}}' \
          BAD_CONNECTION_QUALITY_COLOR='{{@@ light_theme_color @@}}' \
          INACTIVE_CONNECTION_COLOR='{{@@ i3bar_inactive_color @@}}' \
          CABLE_LABEL='󱎔' \
          WIRELESS_LABEL='󰤨' \
          LABEL_SEPARATOR='<span size=\"1.8pt\"> </span>' \
          PANGO_PROPS='size=\"140%\" font_weight=\"bold\"' \
          clean install

    # This action installs the packages providing the commands used in the root
    # mrconfig file
    mrconfig: |-
      case "$DISTRO" in
          'arch')
              pacman -S --needed jq
              ;;

          'debian')
              apt-get install jq
              ;;
      esac

    # This action enables the systemd service file passed as an argument
    systemd-enable: basename '{0}' '.service' | xargs systemctl enable --now

    # This action applies the timezone settings.
    # In Debian, non-interactive mode in dpkg-reconfigure needs both
    # /etc/timezone and /etc/localtime in place to work. /etc/timezone is the
    # dotfile itself ({0} here), while /etc/localtime is set according to the
    # Debian wiki: https://wiki.debian.org/TimeZoneChanges
    timezone: |-
      case "$DISTRO" in
          'arch')
              xargs timedatectl set-timezone < '{0}'
              rm '{0}'
              ;;

          'debian')
              xargs -I '@' cp --remove-destination '/usr/share/zoneinfo/@' \
                  /etc/localtime < '{0}'
              dpkg-reconfigure --frontend noninteractive tzdata
              ;;
      esac

    # This action creates the hid group used in udev rules
    udev-hid: groupadd --force --system hid

    xkb: sh ./actions/xkb.sh

config:
  backup: false
  banner: true
  create: true
  dotpath: dotfiles
  force_chmod: true
  func_file:
  - python/functions.py
  ignoreempty: true
  import_actions:
  - yaml/actions/shared.yaml
  import_configs:
  - yaml/profiles/all-distros/all-hosts/{{@@ user @@}}/{{@@ display_server @@}}.yaml:optional
  - yaml/profiles/all-distros/all-hosts/all-users/shared.yaml
  - yaml/profiles/{{@@ env['DISTRO'] @@}}/all-hosts/{{@@ user @@}}/*.yaml:optional
  import_variables:
  - yaml/variables/{{@@ env['DISTRO'] @@}}/{{@@ env['HOST'] @@}}/{{@@ user @@}}/*.yaml:optional
  - yaml/variables/{{@@ env['DISTRO'] @@}}/{{@@ env['HOST'] @@}}/all-users/*.yaml:optional
  - yaml/variables/{{@@ env['DISTRO'] @@}}/all-hosts/{{@@ user @@}}/*.yaml:optional
  - yaml/variables/{{@@ env['DISTRO'] @@}}/all-hosts/all-users/*.yaml:optional
  - yaml/variables/all-distros/{{@@ env['HOST'] @@}}/{{@@ user @@}}/*.yaml:optional
  - yaml/variables/all-distros/{{@@ env['HOST'] @@}}/all-users/*.yaml:optional
  - yaml/variables/all-distros/all-hosts/{{@@ user @@}}/*.yaml:optional
  - yaml/variables/all-distros/all-hosts/all-users/*.yaml
  keepdot: false
  link_dotfile_default: nolink
  link_on_import: nolink
  longkey: false
  showdiff: true
  workdir: ~/.config/dotdrop

dotfiles:
  d_applications:
    src: usr/share/applications
    dst: /usr/share/applications
  d_i3blocks_keyindicator2:
    src: usr/local/src/i3blocks/keyindicator2
    dst: /usr/local/src/i3blocks/keyindicator2
    actions:
    - i3blocks_keyindicator2
    cmpignore:
    - '*.o'
    - keyindicator2
    instignore:
    - '*.o'
    - keyindicator2
    upignore:
    - '*.o'
    - keyindicator2
  d_i3blocks_network-status:
    src: usr/local/src/i3blocks/network-status
    dst: /usr/local/src/i3blocks/network-status
    actions:
    - i3blocks_network-status
    cmpignore:
    - '*.o'
    - network-status
    instignore:
    - '*.o'
    - network-status
    upignore:
    - '*.o'
    - network-status
  d_myrepos-lib:
    src: usr/local/share/mr
    # Dynamic path since it's used somewhere else too
    dst: '{{@@ mr_libs_path @@}}'
  f_80i3blocks:
    src: etc/apt/apt.conf.d/80i3blocks
    dst: /etc/apt/apt.conf.d/80i3blocks
  f_99-no-wireless-on-wired:
    src: etc/NetworkManager/dispatcher.d/99-no-wireless-on-wired
    dst: /etc/NetworkManager/dispatcher.d/99-no-wireless-on-wired
    chmod: 755
  f_99-philips-tv-hdmi.conf:
    src: etc/wireplumber/wireplumber.conf.d/99-philips-tv-hdmi.conf
    dst: /etc/wireplumber/wireplumber.conf.d/99-philips-tv-hdmi.conf
  f_containers_nodocker:
    src: etc/containers/nodocker
    dst: /etc/containers/nodocker
  f_containers_compose.conf:
    src: etc/containers/containers.conf.d/compose.conf
    dst: /etc/containers/containers.conf.d/compose.conf
  f_containers_default_registry.conf:
    src: etc/containers/registries.conf.d/default-registry.conf
    dst: /etc/containers/registries.conf.d/default-registry.conf
  f_ddclient.conf:
    src: etc/ddclient.conf
    # Dynamic path since it differs across distros
    dst: '{{@@ ddclient_dst_path @@}}'
    actions:
    - ddclient '{{@@ _dotfile_abs_dst @@}}'
  f_dotnet_bash_completion:
    src: usr/local/share/bash-completion/completions/dotnet
    dst: /usr/local/share/bash-completion/completions/dotnet
  f_dotnet_zsh_completion:
    src: usr/local/share/zsh/site-functions/_dotnet
    dst: /usr/local/share/zsh/site-functions/_dotnet
  f_etc_zshrc:
    src: etc/zsh/zshrc
    # Dynamic path since the dotfile content is appended to dst
    dst: '{{@@ zsh_tmp_dst @@}}'
    chmod: 600
    actions:
    - _create_if_empty '{{@@ etc_zshrc_dst @@}}' '#!/usr/bin/env zsh\n'
    - _strip '{{@@ etc_zshrc_append_marker @@}}' '{{@@ etc_zshrc_dst @@}}'
    - _append_tmp '{{@@ etc_zshrc_dst @@}}' '{{@@ zsh_tmp_dst @@}}'
  f_grub:
    src: etc/default/grub
    dst: /etc/default/grub
    actions:
    - grub
  f_hostname:
    src: etc/hostname
    dst: /etc/hostname
  f_i3_sway_10-systemd:
    src: shared/i3-sway/systemd/10-systemd
    dst: /etc/{{@@ wm_name @@}}/config.d/10-systemd
  f_i3_sway_systemd-session.target:
    src: shared/i3-sway/systemd/systemd-session.target
    dst: /etc/systemd/user/{{@@ wm_name @@}}-session.target
  f_i3_sway_systemd-session-watch.service:
    src: shared/i3-sway/systemd/systemd-session-watch.service
    dst: /etc/systemd/user/{{@@ wm_name @@}}-session-watch.service
  f_i3blocks_gh-release-updates:
    src: usr/lib/i3blocks/gh-release-updates
    dst: /usr/lib/i3blocks/gh-release-updates
    chmod: 755
  f_i3blocks_nmcli-connection-status:
    src: usr/lib/i3blocks/nmcli-connection-status
    dst: /usr/lib/i3blocks/nmcli-connection-status
    chmod: 755
  f_keyboard:
    src: etc/default/keyboard
    dst: /etc/default/keyboard
  f_logind.conf.d_lid-switch.conf:
    src: etc/systemd/logind.conf.d/lid-switch.conf
    dst: /etc/systemd/logind.conf.d/lid-switch.conf
  f_lightdm-gtk-greeter.conf.d_02_custom.conf:
    src: usr/share/lightdm/lightdm-gtk-greeter.conf.d/02_custom.conf
    dst: /usr/share/lightdm/lightdm-gtk-greeter.conf.d/02_custom.conf
  f_lightdm.conf.d_02_custom.conf:
    src: usr/share/lightdm/lightdm.conf.d/02_custom.conf
    dst: /usr/share/lightdm/lightdm.conf.d/02_custom.conf
  f_local_bin_nordvpn-config:
    src: usr/local/bin/nordvpn-config
    dst: /usr/local/bin/nordvpn-config
  f_locale:
    src: etc/default/locale
    dst: /etc/default/locale
  f_locale.conf:
    src: etc/locale.conf
    dst: /etc/locale.conf
  f_login.defs:
    src: etc/login.defs
    # Dynamic path since the dotfile content is appended to dst
    dst: '{{@@ getty_login_tmp_dst @@}}'
    chmod: 600
    actions:
    - _strip '{{@@ login_defs_append_marker @@}}' '{{@@ login_defs_dst @@}}'
    - _append_tmp '{{@@ login_defs_dst @@}}' '{{@@ getty_login_tmp_dst @@}}'
  f_mrconfig:
    src: opt/mrconfig
    dst: /opt/.mrconfig
  f_networkd_20-wired.network:
    src: etc/systemd/network/20-wired.network
    dst: /etc/systemd/network/20-wired.network
  f_NetworkManager_conf.d_dns.conf:
    src: etc/NetworkManager/conf.d/dns.conf
    dst: /etc/NetworkManager/conf.d/dns.conf
    actions:
    - enable-systemd-resolved
  f_nix.conf:
    src: etc/xdg/nix/nix.conf
    dst: /etc/xdg/nix/nix.conf
  f_pacman_i3blocks-contrib-arch-update.hook:
    src: etc/pacman.d/hooks/i3blocks-contrib-arch-update.hook
    dst: /etc/pacman.d/hooks/i3blocks-contrib-arch-update.hook
  f_pam.d_login:
    src: etc/pam.d/login
    # Dynamic path since the dotfile content is appended to dst
    dst: '{{@@ startup_tmp_dst @@}}'
    chmod: 600
    actions:
    - _strip '{{@@ pam_login_append_marker @@}}' '{{@@ pam_login_dst @@}}'
    - _append_tmp '{{@@ pam_login_dst @@}}' '{{@@ startup_tmp_dst @@}}'
  f_pam.d_sudo:
    src: etc/pam.d/sudo
    # Dynamic path since the dotfile content is appended to dst
    dst: '{{@@ environment_tmp_dst @@}}'
    chmod: 600
    actions:
    - _strip '{{@@ pam_sudo_append_marker @@}}' '{{@@ pam_sudo_dst @@}}'
    - _append_tmp '{{@@ pam_sudo_dst @@}}' '{{@@ environment_tmp_dst @@}}'
  f_pam_env.conf:
    src: etc/security/pam_env.conf
    # Dynamic path since the dotfile content is appended to dst
    dst: '{{@@ environment_tmp_dst @@}}'
    chmod: 600
    actions:
    - _strip '{{@@ pam_env_conf_append_marker @@}}' '{{@@ pam_env_conf_dst @@}}'
    - _append_tmp '{{@@ pam_env_conf_dst @@}}' '{{@@ environment_tmp_dst @@}}'
  f_raspberry.automount:
    src: etc/systemd/system/mnt-raspberry.automount
    dst: /etc/systemd/system/mnt-raspberry.automount
    actions:
    - systemd-enable '{{@@ _dotfile_abs_src @@}}'
  f_raspberry.mount:
    src: etc/systemd/system/mnt-raspberry.mount
    dst: /etc/systemd/system/mnt-raspberry.mount
  f_sshd_config.d_990-raspberry.conf:
    src: etc/ssh/sshd_config.d/990-raspberry.conf
    dst: /etc/ssh/sshd_config.d/990-raspberry.conf
  f_sudo_custom:
    src: etc/sudoers.d/custom
    dst: /etc/sudoers.d/custom
  f_systemd_getty:
    src: etc/systemd/system/getty@tty1.service.d/override.conf
    dst: /etc/systemd/system/getty@tty1.service.d/override.conf
  f_udev_999-hid.rules:
    src: etc/udev/rules.d/999-hid.rules
    dst: /etc/udev/rules.d/999-hid.rules
    actions:
    - udev-hid
  f_temp-throttle.conf:
    src: etc/temp-throttle.conf
    dst: /etc/temp-throttle.conf
  f_temp-throttle.service.d_override.conf:
    src: etc/systemd/system/temp-throttle.service.d/override.conf
    dst: /etc/systemd/system/temp-throttle.service.d/override.conf
  f_timezone:
    src: etc/timezone
    dst: /etc/timezone
    actions:
    - timezone '{{@@ _dotfile_abs_dst @@}}'
  f_whole-fs.exports:
    src: etc/exports.d/whole-fs.exports
    dst: /etc/exports.d/whole-fs.exports
  f_xkb_base.lst:
    src: usr/share/X11/xkb/rules/base.lst
    # Dynamic path since the dotfile content is inserted into dst
    dst: '{{@@ xkb_tmp_dst @@}}'
    chmod: 600
    actions:
    - >-
      _strip_file '{{@@ _dotfile_abs_src @@}}' '{{@@ base_lst_dst @@}}'
    - >-
      _insert_match '^\s*\sintl\s\s*us' '{{@@ xkb_tmp_dst @@}}'
        '{{@@ base_lst_dst @@}}'
  f_xkb_base.xml:
    src: usr/share/X11/xkb/rules/base.xml
    # Dynamic path since the dotfile content is inserted into dst
    dst: '{{@@ xkb_tmp_dst @@}}'
    chmod: 600
    actions:
    - _strip_xml ".//*[name='intl-custom'].." '{{@@ base_xml_dst @@}}'
    - >-
      _insert_xml ".//*[description='English (US, intl., with dead keys)'].."
        '{{@@ xkb_tmp_dst @@}}' '{{@@ base_xml_dst @@}}'
  f_xkb_us:
    src: usr/share/X11/xkb/symbols/us
    dst: '{{@@ xkb_tmp_dst @@}}'
    chmod: 600
    # Dynamic path since the dotfile content is appended to dst
    actions:
    - _strip '{{@@ symbols_append_marker @@}}' '{{@@ symbols_dst @@}}'
    - _append_tmp '{{@@ symbols_dst @@}}' '{{@@ xkb_tmp_dst @@}}'

dynvariables:
  # This variable determines whether the "i3blocks" profile should include the
  # "gh-releases" profile. It is made necessary by the fact that such type of
  # manual installation mechanisms are only necessary on Debian, as on Arch
  # there is usually an AUR package.
  #
  # The variable needs to be defined here, rather than in a distro-specific
  # variables files, because variables from external files are not yet
  # available when including profiles. The '-empty' postfixed profile is just a
  # placeholder, and it doesn't actually exist.
  i3_blocks_gh_release_include: |-
    case "$DISTRO" in
        'arch')
            echo 'gh-release-empty'
            ;;

        'debian')
            echo 'gh-release'
            ;;
    esac

profiles:
  # This profile groups configuration files for CLI-based applictions.
  cli:
    dotfiles:
    - f_containers_nodocker
    - f_containers_compose.conf
    - f_containers_default_registry.conf
    - f_nix.conf
    import:
    - yaml/dotfiles/all-distros/{{@@ env['HOST'] @@}}/{{@@ user @@}}/cli.yaml:optional

  # This profile contains dotfiles used to setup the global shell environment
  environment:
    dotfiles:
    - f_pam_env.conf
    - f_pam.d_sudo
    actions:
    - environment
    - _rm '{{@@ environment_tmp_dst @@}}'
    dynvariables:
      environment_tmp_dst: mktemp /tmp/environment-append.XXX
    variables:
      pam_env_conf_append_marker: >-
        PAM environment file for user environment variables
      pam_sudo_append_marker: Load PAM environment variables
      pam_env_conf_dst: /etc/security/pam_env.conf
      pam_sudo_dst: /etc/pam.d/sudo

  # This profile groups dotfiles used to configure login from a getty
  getty-login:
    dotfiles:
    - f_login.defs
    - f_systemd_getty
    actions:
    - _rm '{{@@ getty_login_tmp_dst @@}}'
    dynvariables:
      getty_login_tmp_dst: mktemp /tmp/getty-login-append.XXX
    variables:
      login_defs_append_marker: Local options
      login_defs_dst: /etc/login.defs

  # This profile gathers the graphical login manager dotfiles
  graphical-login:
    dotfiles:
    - f_lightdm.conf.d_02_custom.conf
    - f_lightdm-gtk-greeter.conf.d_02_custom.conf

  # This profile contains dotfiles related to hardware-related configuration
  hardware:
    dotfiles:
    - f_99-philips-tv-hdmi.conf
    - f_udev_999-hid.rules

  # This profile includes the i3 session dotfiles that require root privileges
  # to be installed
  i3:
    dotfiles:
    - d_local_lib_i3ipc-extras
    - f_i3_sway_10-systemd
    - f_i3_sway_systemd-session.target
    - f_i3_sway_systemd-session-watch.service
    - f_local_bin_default-ws-layout
    - f_local_bin_systemd-i3-session
    - f_local_bin_systemd-i3-session-watch
    import:
    - yaml/dotfiles/all-distros/{{@@ env['HOST'] @@}}/{{@@ user @@}}/i3-sway.yaml:optional
    include:
    - i3blocks
    - x11
    variables:
      wm_name: i3

  # This profile groups i3blocks-related dotfiles, both for contrib and custom
  # blocklets
  i3blocks:
    dotfiles:
    - d_i3blocks_network-status
    import:
    - yaml/dotfiles/{{@@ env['DISTRO'] @@}}/all-hosts/{{@@ user @@}}/i3blocks.yaml:optional
    - yaml/dotfiles/all-distros/all-hosts/{{@@ user @@}}/{{@@ env['DISPLAY_SERVER'] @@}}-i3blocks.yaml:optional
    include:
    - '{{@@ i3_blocks_gh_release_include @@}}'

  # This profile holds dotfiles used to install software manually, that is
  # without the aid of a package manager
  manual:
    import:
    - yaml/dotfiles/{{@@ env['DISTRO'] @@}}/{{@@ env['HOST'] @@}}/{{@@ user @@}}/manual.yaml:optional
    include:
    - gh-release

  # This profile contains network-related configuration files
  network:
    include:
    - host-refresh
    import:
    - yaml/dotfiles/all-distros/{{@@ env['HOST'] @@}}/{{@@ user @@}}/network.yaml:optional
    - yaml/dotfiles/{{@@ env['DISTRO'] @@}}/{{@@ env['HOST'] @@}}/{{@@ user @@}}/network.yaml:optional

  # This profile collects useful configuration for accessing a host remotely
  remote-access:
    dotfiles:
    - f_sshd_config.d_990-raspberry.conf
    - f_whole-fs.exports

  # This profile contains dotfiles used to configure the code workspace
  repos:
    dotfiles:
    - d_myrepos-lib

  # This profile collects system startup jobs and configuration dotfiles
  startup:
    dotfiles:
    - f_temp-throttle.conf
    - f_temp-throttle.service.d_override.conf
    import:
    - yaml/dotfiles/all-distros/{{@@ env['HOST'] @@}}/{{@@ user @@}}/startup.yaml:optional
    - yaml/dotfiles/{{@@ env['DISTRO'] @@}}/{{@@ env['HOST'] @@}}/{{@@ user @@}}/startup.yaml:optional
    include:
    - startup-{{@@ display_server @@}}
    actions:
    - _rm '{{@@ startup_tmp_dst @@}}'
    dynvariables:
      startup_tmp_dst: mktemp /tmp/startup-append.XXX
    variables:
      pam_login_append_marker: >-
        GNOME Keyring startup and automatic login keyring unlocking
      pam_login_dst: /etc/pam.d/login

  # This profile contains generic system-wide configuration, such as sudo and
  # locales
  system-tweaks:
    dotfiles:
    - f_sudo_custom
    include:
    - system-tweaks-{{@@ display_server @@}}
    import:
    - yaml/dotfiles/all-distros/{{@@ env['HOST'] @@}}/{{@@ user @@}}/system-tweaks.yaml:optional
    - yaml/dotfiles/{{@@ env['DISTRO'] @@}}/all-hosts/{{@@ user @@}}/locales.yaml
    actions:
    - locales

  # This profile includes sway dotfiles that require root privileges to be
  # installed
  sway:
    dotfiles:
    - d_local_lib_i3ipc-extras
    - f_i3_sway_10-systemd
    - f_i3_sway_systemd-session.target
    - f_i3_sway_systemd-session-watch.service
    - f_local_bin_default-ws-layout
    - f_local_bin_launcher
    - f_local_bin_systemd-sway-session
    - f_local_bin_systemd-sway-session-watch
    import:
    - yaml/dotfiles/all-distros/{{@@ env['HOST'] @@}}/{{@@ user @@}}/i3-sway.yaml:optional
    include:
    - i3blocks
    variables:
      wm_name: sway

  # This profile groups keyboard layout dotfiles
  xkb:
    dotfiles:
    - f_xkb_base.lst
    - f_xkb_base.xml
    - f_xkb_us
    actions:
    - xkb
    - _rm '{{@@ xkb_tmp_dst @@}}'
    import:
    - yaml/dotfiles/{{@@ env['DISTRO'] @@}}/all-hosts/{{@@ user @@}}/xkb.yaml:optional
    dynvariables:
      xkb_tmp_dst: mktemp /tmp/xkb-dotfiles.XXX
    variables:
      base_lst_dst: /usr/share/X11/xkb/rules/base.lst
      base_xml_dst: /usr/share/X11/xkb/rules/base.xml
      symbols_append_marker: Custom layout symbols
      symbols_dst: /usr/share/X11/xkb/symbols/us

  # This profile holds the system-wide zsh dotfiles
  zsh-system:
    dotfiles:
    - f_etc_zshrc
    dynvariables:
      zsh_tmp_dst: mktemp /tmp/zsh-dotfiles.XXX
    variables:
      etc_zshrc_append_marker: '# Custom'
      etc_zshrc_dst: /etc/zsh/zshrc
    actions:
    - _rm '{{@@ zsh_tmp_dst @@}}'

variables:
  # This variable is used to differentiate between user and root configuration
  # in some dotfiles.
  user: root

  rustup_home: /opt/rustup

  # These variables are used to tell which display server is in use on the
  # system dotdrop is currently executing. They're defined here as they're used
  # in this config file when importing sub-config and including profiles, when
  # variables from external files are not yet available.
  display_server: '{{@@ env["DISPLAY_SERVER"] @@}}'
  is_headless: '{{@@ display_server == "none" @@}}'
  on_wayland: '{{@@ display_server == "wayland" @@}}'
  on_x11: '{{@@ display_server == "x11" @@}}'
